name: Grafana Syncer
defaults:
  run:
    shell: bash

env:
  DASHBOARDS: "rendered/kube-burner.json test/dir"

on:
  push:
    branches: [ master, auto-dashboard-load ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2

    - name: Compile dashboards
      run: make build

    # The secret GRAFANA_URL must be set with the format http://username:password@url.org without a trailing /
    - name: Import dashboards to grafana
      run: >
        readarray -t dashboard_list < <(sed -n '/{/,/}/{s/[^:]*:[^"]*"\([^"]*\).*/\1/p;}' $DASHBOARDS);
        for path in ${dashboard_list}; do
        echo "Importing ${path}";
        dashboard=$(cat ${path});
        echo "{\"dashboard\": ${dashboard}, \"overwrite\": true}" |
        curl -Ss -XPOST -H "Content-Type: application/json" -H "Accept: application/json" -d@-
        "${{ secrets.GRAFANA_URL }}/api/dashboards/db" -o /dev/null;
        done

